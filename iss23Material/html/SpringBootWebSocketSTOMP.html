
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>SpringBootWebSocketSTOMP &#8212; iss23 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <script src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">iss23 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SpringBootWebSocketSTOMP</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="springbootwebsocketstomp">
<h1>SpringBootWebSocketSTOMP<a class="headerlink" href="#springbootwebsocketstomp" title="Permalink to this headline">¶</a></h1>
<p>Il protocollo WebSocket consente di implementare la comunicazione bidirezionale tra le applicazioni.
È importante sapere che HTTP viene utilizzato solo per l’handshake iniziale.
Dopo che ciò accade, la connessione HTTP viene aggiornata a una connessione TCP/IP appena aperta utilizzata da un WebSocket.</p>
<p>Il protocollo WebSocket è un protocollo di livello piuttosto basso.
Definisce come un flusso di byte viene trasformato in frame. Un frame può contenere un testo o un messaggio binario.
Poiché il messaggio stesso non fornisce alcuna informazione aggiuntiva su come instradarlo o elaborarlo,
è difficile implementare applicazioni più complesse senza scrivere codice aggiuntivo.
Fortunatamente, la specifica WebSocket consente l’utilizzo di sottoprotocolli che operano
a un livello di applicazione superiore. Uno di questi, supportato dallo Spring Framework, è STOMP.</p>
<p>STOMP è un semplice protocollo di messaggistica basato su testo che è stato inizialmente creato
per linguaggi di scripting come Ruby, Python e Perl per connettersi a broker di messaggi aziendali.
Grazie a STOMP, clienti e broker sviluppati in diverse lingue possono inviare e ricevere messaggi
gli uni dagli altri. Il protocollo WebSocket è talvolta chiamato TCP per Web. Analogamente,
STOMP si chiama HTTP per il Web. Definisce una manciata di tipi di frame mappati su frame WebSocket,
ad esempio , CONNECT, SUBSCRIBE, UNSUBSCRIBE, ACKo SEND. Questi comandi da un lato sono molto utili
per gestire la comunicazione mentre dall’altro ci permettono di implementare soluzioni con funzionalità
più sofisticate come il riconoscimento dei messaggi.</p>
<section id="websocket-in-springboot-versione-stomp">
<h2>WebSocket in SpringBoot: versione STOMP<a class="headerlink" href="#websocket-in-springboot-versione-stomp" title="Permalink to this headline">¶</a></h2>
<p><span class="blue">Simple Text Oriented Message Protocol</span>
(STOMP) è un protocollo di messaggistica text-based progettato per operare con MOM
(Message Orinented Middleware) ed originariamente creato per l’uso
in linguaggi di scripting con frame ispirati a HTTP.
E’ una alternativa a AMQP (Advanced Message Queuing Protocol) e JMS (Java Messaging Service).</p>
<p>STOMP può essere utilizzato anche senza WebSocket, ad esempio tramite una connessione
Telnet, HTTP o un  message broker. Tuttavia,
STOMP è ampiamente supportato e adatto per l’uso su WebSocket e sul web.</p>
<p>Un meccansimo noto come <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#Heart-beating">Heart-beating</a> può essere usato opzionalmente per verificare lo stato
della sottostante connessione TCP e che l’endpoint remoto sia operativo.</p>
<p>STOMP è progettato per interagire con un <span class="blue">broker di messaggi</span> realizzato in memoria (lato server);
dunque, rispetto all’uso delle WebSocket, rende più semplice inviare messaggi solo
a un particolare utente o ad utenti che sono iscritti a un particolare argomento.</p>
<section id="setup-e-dipendenze">
<h3>Setup e Dipendenze<a class="headerlink" href="#setup-e-dipendenze" title="Permalink to this headline">¶</a></h3>
<p>Partendo dal SetUp precedente <a href="#id2"><span class="problematic" id="id3">`SetupNoStomp`_</span></a>, aggiungiamo nel file <code class="docutils literal notranslate"><span class="pre">build.gradle</span></code>
alcune dipendenze  rispetto alle precenti <a href="#id4"><span class="problematic" id="id5">setupdependencies_</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="o">//</span><span class="n">Added</span> <span class="k">for</span> <span class="n">STOMP</span>
  <span class="n">implementation</span> <span class="s1">&#39;org.webjars:stomp-websocket:2.3.4&#39;</span>
</pre></div>
</div>
</section>
<section id="websocket-vs-sockjs">
<h3>WebSocket vs. SockJs<a class="headerlink" href="#websocket-vs-sockjs" title="Permalink to this headline">¶</a></h3>
<p>A partire dal 2018, il supporto WebSocket nei browser è quasi onnipresente.
Tuttavia, per supportare vecchi browser, potrebbe essere necessario fare uso di
<a class="reference external" href="https://openbase.com/js/sockjs/documentation#what-is-sockjs">SockJS</a>, con le seguenti avvertenze:</p>
<ul class="simple">
<li><p>Le convenzioni del protocollo URL sono diverse per WebSocket ( <code class="docutils literal notranslate"><span class="pre">ws:/</span></code> o <code class="docutils literal notranslate"><span class="pre">wss:</span></code>) e SockJS ( <code class="docutils literal notranslate"><span class="pre">http:</span></code> o <code class="docutils literal notranslate"><span class="pre">https:</span></code>).</p></li>
<li><p>Le sequenze di handshake interne sono diverse, quindi alcuni broker utilizzeranno punti finali diversi per entrambi i protocolli.</p></li>
<li><p>Nessuno di questi consente di impostare intestazioni personalizzate durante l’handshake <em>HTTP</em>.</p></li>
<li><p><em>SockJS</em> supporta internamente diversi meccanismi di trasporto. Si potrebbe dover affrontare limitazioni
specifiche a seconda del trasporto effettivo in uso.</p></li>
<li><p>La riconnessione automatica non è abbastanza affidabile con <em>SockJS</em>.</p></li>
<li><p>Gli heartbeat potrebbero non essere supportati su <em>SockJS</em> da alcuni broker.</p></li>
<li><p><em>SockJS</em> non consente più di una connessione simultanea allo stesso broker.
Questo di solito non è un problema per la maggior parte delle applicazioni.</p></li>
</ul>
</section>
<section id="configurazione">
<h3>Configurazione<a class="headerlink" href="#configurazione" title="Permalink to this headline">¶</a></h3>
<p>Specifichiamo la porta <code class="docutils literal notranslate"><span class="pre">8087</span></code>,  ponendo in <em>resources/application.properties</em></p>
<blockquote>
<div><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="p">.</span><span class="na">port</span> <span class="o">=</span> <span class="mi">8087</span>
</pre></div>
</div>
</div></blockquote>
<p>Il servizio in versione STOMP viene configurato in SpringBoot da una classe che implementa l’interfaccia
<code class="docutils literal notranslate"><span class="pre">WebSocketMessageBrokerConfigurer</span></code> :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableWebSocketMessageBroker</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSocketConfig</span> <span class="kd">implements</span> <span class="n">WebSocketMessageBrokerConfigurer</span><span class="p">{</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureMessageBroker</span><span class="p">(</span><span class="n">MessageBrokerRegistry</span> <span class="n">config</span><span class="p">){</span>
 <span class="n">config</span><span class="p">.</span><span class="na">enableSimpleBroker</span><span class="p">(</span><span class="s">&quot;/demoTopic&quot;</span><span class="p">);</span>            <span class="c1">//(a)</span>
 <span class="n">config</span><span class="p">.</span><span class="na">setApplicationDestinationPrefixes</span><span class="p">(</span>           <span class="c1">//(b)</span>
                <span class="s">&quot;/demoInput&quot;</span><span class="p">,</span><span class="s">&quot;/anotherInput&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerStompEndpoints</span><span class="p">(</span><span class="n">StompEndpointRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">registry</span><span class="p">.</span><span class="na">addEndpoint</span><span class="p">(</span><span class="s">&quot;/unibo&quot;</span><span class="p">);</span>  <span class="c1">//.withSockJS();  //(c)</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nella configurazione specificata, il servizio:</p>
<ul>
<li><p>Crea il broker di messaggi in memoria con una o più destinazioni per l’invio e la ricezione dei messaggi.</p>
<ul class="simple">
<li><p><strong>(a)</strong> abilita un broker su memoria comune, con prefisso di destinazione <code class="docutils literal notranslate"><span class="pre">demoTopic</span></code>. I client
si possono sottoscrivere a endpoint che iniziano con questo prefisso, ad es. <code class="docutils literal notranslate"><span class="pre">/demoTopic/output</span></code>.</p></li>
<li><p><strong>(b)</strong> imposta``demoInput`` (e <code class="docutils literal notranslate"><span class="pre">anotherInput</span></code>) come prefissi di destinazione dell’applicazione.
Il prefisso <code class="docutils literal notranslate"><span class="pre">demoInput</span></code> viene utilizzato per filtrare le destinazioni gestite dai metodi annotati
con <code class="docutils literal notranslate"><span class="pre">&#64;MessageMapping</span></code> (si veda <a class="reference internal" href="#il-controller"><span class="std std-ref">Il controller</span></a>).
I clienti quindi invieranno messaggi agli endpoint che iniziano con <code class="docutils literal notranslate"><span class="pre">/demoInput/unibo</span></code> oppure
<code class="docutils literal notranslate"><span class="pre">/anotherInput/unibo</span></code>.</p></li>
</ul>
</li>
<li><p><strong>(c)</strong> abilita  il supporto STOMP su <em>WebSocket</em> (escludiamo <em>SockJS</em>) registrando l’endpoint <code class="docutils literal notranslate"><span class="pre">unibo</span></code>.
Dunque l’indirizzo per connetersi sarà: <code class="docutils literal notranslate"><span class="pre">ws://&lt;serverIP&gt;:8080/unibo</span></code>.</p>
<blockquote>
<div></div></blockquote>
</li>
</ul>
<a class="reference internal image-reference" href="_images/StompArch.PNG"><img alt="_images/StompArch.PNG" class="align-center" src="_images/StompArch.PNG" style="width: 80%;" /></a>
</section>
<section id="componenti">
<h3>Componenti<a class="headerlink" href="#componenti" title="Permalink to this headline">¶</a></h3>
<p>I componenti-base della applicazione in versione STOMP sono quindi oggetti DTO (<span class="blue">Data Transfer Object</span>)
rappresentati dalle classi <code class="docutils literal notranslate"><span class="pre">InputMessage</span></code> e <code class="docutils literal notranslate"><span class="pre">OutputMessage</span></code> .</p>
<table class="colwidths-given docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InputMessage</span> <span class="p">{</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">input</span><span class="p">;</span>
<span class="kd">public</span> <span class="nf">InputMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;}</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getInput</span><span class="p">(){</span><span class="k">return</span> <span class="n">input</span><span class="p">;}</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setInput</span><span class="p">(</span><span class="n">String</span> <span class="n">input</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
<td><div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutputMessage</span><span class="p">{</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="p">;</span>
<span class="kd">public</span> <span class="nf">OutputMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">content</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">;</span> <span class="p">}</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">getContent</span><span class="p">(){</span>
    <span class="k">return</span> <span class="n">content</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="la-funzione-del-servizio">
<h3>La funzione del servizio<a class="headerlink" href="#la-funzione-del-servizio" title="Permalink to this headline">¶</a></h3>
<p>Il servizio:</p>
<ol class="arabic simple">
<li><p>riceve un messaggio (in formato JSON) inviato su endpoint= <code class="docutils literal notranslate"><span class="pre">/demoInput/unibo</span></code>;
il messaggio viene mappato in Java usando come DTO (<span class="blue">Data Transfer Object</span>)
la classe <code class="docutils literal notranslate"><span class="pre">InputMessage</span></code></p></li>
<li><p>elabora il messaggio</p></li>
<li><p>costruisce un messaggio di risposta di tipo <code class="docutils literal notranslate"><span class="pre">OutputMessage</span></code> e lo pubblica
(ancora in formato JSON) su endpoint <code class="docutils literal notranslate"><span class="pre">/demoTopic/output</span></code>.</p></li>
</ol>
<p>La conversione dei messaggi da JSon a Java e viceversa è effettuata in modo automatico
in SpringBoot, una volta definito un opportuno Controller.</p>
</section>
<section id="il-controller">
<h3>Il controller<a class="headerlink" href="#il-controller" title="Permalink to this headline">¶</a></h3>
<p>Il controller specifica la gestione delle richieste <code class="docutils literal notranslate"><span class="pre">WebSocket</span></code>, che avviene in modo simile
alle normali richieste <code class="docutils literal notranslate"><span class="pre">HTTP</span></code>, ma utilizzando <code class="docutils literal notranslate"><span class="pre">&#64;SubscribeMappinge</span></code> o <code class="docutils literal notranslate"><span class="pre">&#64;MessageMapping</span></code>
(e non <code class="docutils literal notranslate"><span class="pre">&#64;RequestMapping</span></code> o <code class="docutils literal notranslate"><span class="pre">&#64;GetMapping</span></code>).</p>
<p>Nel caso specifico, utilizziamo <code class="docutils literal notranslate"><span class="pre">&#64;MessageMapping</span></code> per mappare i messaggi diretti a <code class="docutils literal notranslate"><span class="pre">unibo</span></code>.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HIController</span> <span class="p">{</span>

    <span class="nd">@MessageMapping</span><span class="p">(</span><span class="s">&quot;/unibo&quot;</span><span class="p">)</span>
    <span class="nd">@SendTo</span><span class="p">(</span><span class="s">&quot;/demoTopic/output&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">OutputMessage</span> <span class="nf">elabInput</span><span class="p">(</span>
                <span class="n">InputMessage</span> <span class="n">msg</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">OutputMessage</span><span class="p">(</span><span class="s">&quot;Elaborated: &quot;</span>
           <span class="o">+</span> <span class="n">HtmlUtils</span><span class="p">.</span><span class="na">htmlEscape</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getInput</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>L’annotazione <code class="docutils literal notranslate"><span class="pre">&#64;SendTo</span></code> indica che il valore di ritorno
deve essere inviato come <code class="docutils literal notranslate"><span class="pre">OutputMessage</span></code> alla destinazione specificata <code class="docutils literal notranslate"><span class="pre">/demoTopic/output</span></code>.</p></li>
<li><p>L’operazione <code class="docutils literal notranslate"><span class="pre">HtmlUtils.htmlEscape</span></code> elabora il testo nel messaggio di input in modo da poter
essere reso nel DOM lato client.</p></li>
</ul>
<p>L’applicazione STOMP si limita alla gestione di messaggi di tipo testo, offrendo all’utente due diverse
pagine: una con layout ‘naive’ e una con layout basato su Bootstrap:</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span>    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">entryMinimal</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;indexNaive&quot;</span><span class="p">;</span> <span class="c1">//usa wsStompMinimal.js</span>
<span class="p">}</span>

    <span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/better&quot;</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">entryBetter</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&quot;indexBetter&quot;</span><span class="p">;</span>    <span class="c1">//usa wsStompBetter.js</span>
    <span class="p">}</span>
</pre></div>
</div>
<section id="pagina-indexnaive-html">
<h4>Pagina indexNaive.html<a class="headerlink" href="#pagina-indexnaive-html" title="Permalink to this headline">¶</a></h4>
<p>Il file  <code class="docutils literal notranslate"><span class="pre">indexNaive.html</span></code> restituito da <code class="docutils literal notranslate"><span class="pre">HIController</span></code> nella richiesta di default
è simile a quanto già introdotto nella versione
non-STOMP <a href="#id6"><span class="problematic" id="id7">`index`_</span></a>, con un set più ampio di dipendenze:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
        <span class="p">.</span><span class="nc">messageAreaStyle</span> <span class="p">{</span>
            <span class="k">text-align</span><span class="p">:</span> <span class="kc">left</span><span class="p">;</span>
            <span class="k">width</span><span class="p">:</span> <span class="mi">80</span><span class="kt">%</span><span class="p">;</span>
            <span class="k">padding</span><span class="p">:</span> <span class="mi">1</span><span class="kt">em</span><span class="p">;</span>
            <span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="kc">black</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/webjars/bootstrap/css/bootstrap.min.css&quot;</span>
                                          <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/main.css&quot;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/webjars/stomp-websocket/stomp.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>wsdemoNoStomp<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;messageArea&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;messageAreaStyle&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;input-fields&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Type a message and hit send:<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;inputmessage&quot;</span><span class="p">/&gt;&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;send&quot;</span><span class="p">&gt;</span>Send<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;wsStompMinimal.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>La pagina HTML utilizza il file <code class="docutils literal notranslate"><span class="pre">wsStompMinimal.js</span></code> identico a <a href="#id8"><span class="problematic" id="id9">`wsminimal`_</span></a> della versione non-STOMP per
quanto riguarda la parte relativa alla gestione della pagina e con nuove funzioni per quanto riguarda
la parte di interazione:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">//Parte di gestione pagina</span>
<span class="p">...</span>

<span class="c1">//Parte di interazione</span>
<span class="kd">function</span> <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">host</span>       <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">addr</span>       <span class="o">=</span> <span class="s2">&quot;ws://&quot;</span> <span class="o">+</span> <span class="nx">host</span>  <span class="o">+</span> <span class="s2">&quot;/unibo&quot;</span>  <span class="p">;</span>
    <span class="kd">var</span> <span class="nx">socket</span>     <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="sb">`Got Message: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="nx">stompClient</span> <span class="o">=</span> <span class="nx">Stomp</span><span class="p">.</span><span class="nx">over</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
    <span class="nx">stompClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">({},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Connected &quot;</span> <span class="o">+</span> <span class="nx">frame</span><span class="p">);</span>
        <span class="nx">stompClient</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">&#39;/demoTopic/output&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">greeting</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">showAnswer</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">greeting</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">content</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">showAnswer</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Answer:&quot;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">jsonMsg</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="o">:</span> <span class="nx">message</span><span class="p">});</span>
    <span class="nx">stompClient</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;/demoInput/unibo&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">jsonMsg</span><span class="p">);</span>
    <span class="nx">addMessageToWindow</span><span class="p">(</span><span class="s2">&quot;Sent Message: &quot;</span> <span class="o">+</span> <span class="nx">message</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="pagina-indexbetter-html">
<h4>Pagina indexBetter.html<a class="headerlink" href="#pagina-indexbetter-html" title="Permalink to this headline">¶</a></h4>
<p>Il file  <code class="docutils literal notranslate"><span class="pre">indexBetter.html</span></code> restituito da <code class="docutils literal notranslate"><span class="pre">HIController</span></code> nella richiesta   <em>/better</em>
è simile a <a href="#id10"><span class="problematic" id="id11">`indexAlsoImages`_</span></a> e fa uso del file  <code class="docutils literal notranslate"><span class="pre">wsStompBetter.js</span></code> simile a  <a href="#id12"><span class="problematic" id="id13">`wsalsoimages`_</span></a></p>
</section>
</section>
<section id="client-in-java-per-programmi">
<h3>Client (in Java per programmi)<a class="headerlink" href="#client-in-java-per-programmi" title="Permalink to this headline">¶</a></h3>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StompClient</span> <span class="p">{</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">URL</span> <span class="o">=</span> <span class="s">&quot;ws://localhost:8080/unibo&quot;</span><span class="p">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">WebSocketStompClient</span> <span class="n">stompClient</span><span class="p">;</span>

<span class="kd">protected</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">connectForSockJs</span><span class="p">(){</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Transport</span><span class="o">&gt;</span> <span class="n">transports</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">transports</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">WebSocketTransport</span><span class="p">(</span><span class="k">new</span> <span class="n">StandardWebSocketClient</span><span class="p">()));</span>
    <span class="n">transports</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">RestTemplateXhrTransport</span><span class="p">());</span>

    <span class="n">SockJsClient</span> <span class="n">sockjsClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SockJsClient</span><span class="p">(</span><span class="n">transports</span><span class="p">);</span>
    <span class="n">stompClient</span>               <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketStompClient</span><span class="p">(</span><span class="n">sockjsClient</span><span class="p">);</span>

<span class="p">}</span>
<span class="kd">protected</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">connectForWebSocket</span><span class="p">(){</span>
    <span class="n">WebSocketClient</span> <span class="n">client</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">StandardWebSocketClient</span><span class="p">();</span>
     <span class="n">stompClient</span>            <span class="o">=</span> <span class="k">new</span> <span class="n">WebSocketStompClient</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//connectForSockJs();  //To be used when the server is based</span>
    <span class="n">connectForWebSocket</span><span class="p">();</span>
    <span class="n">stompClient</span><span class="p">.</span><span class="na">setMessageConverter</span><span class="p">(</span><span class="k">new</span> <span class="n">MappingJackson2MessageConverter</span><span class="p">());</span>

    <span class="n">StompSessionHandler</span> <span class="n">sessionHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyStompSessionHandler</span><span class="p">();</span>
    <span class="n">stompClient</span><span class="p">.</span><span class="na">connect</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">sessionHandler</span><span class="p">);</span>

    <span class="k">new</span> <span class="n">Scanner</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">in</span><span class="p">).</span><span class="na">nextLine</span><span class="p">();</span> <span class="c1">// Don&#39;t close immediately.</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyStompSessionHandler</span> <span class="kd">extends</span> <span class="n">StompSessionHandlerAdapter</span> <span class="p">{</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterConnected</span><span class="p">(</span><span class="n">StompSession</span> <span class="n">session</span><span class="p">,</span> <span class="n">StompHeaders</span> <span class="n">connectedHeaders</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">session</span><span class="p">.</span><span class="na">subscribe</span><span class="p">(</span><span class="s">&quot;/demoTopic/output&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
     <span class="n">session</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;/anotherInput/unibo&quot;</span><span class="p">,</span> <span class="n">getSampleMessage</span><span class="p">());</span>
 <span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleException</span><span class="p">(</span><span class="n">StompSession</span> <span class="n">session</span><span class="p">,</span>
  <span class="n">StompCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">StompHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">payload</span><span class="p">,</span> <span class="n">Throwable</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">....</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Type</span> <span class="nf">getPayloadType</span><span class="p">(</span><span class="n">StompHeaders</span> <span class="n">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">OutputMessage</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
<span class="p">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleFrame</span><span class="p">(</span><span class="n">StompHeaders</span> <span class="n">headers</span><span class="p">,</span> <span class="n">Object</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span><span class="p">(</span> <span class="n">payload</span> <span class="k">instanceof</span> <span class="n">OutputMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OutputMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">OutputMessage</span><span class="p">)</span> <span class="n">payload</span><span class="p">;</span>
     <span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="n">InputMessage</span> <span class="nf">getSampleMessage</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">InputMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputMessage</span><span class="p">();</span>
    <span class="n">msg</span><span class="p">.</span><span class="na">setInput</span><span class="p">(</span><span class="s">&quot;Nicky&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">SpringBootWebSocketSTOMP</a><ul>
<li><a class="reference internal" href="#websocket-in-springboot-versione-stomp">WebSocket in SpringBoot: versione STOMP</a><ul>
<li><a class="reference internal" href="#setup-e-dipendenze">Setup e Dipendenze</a></li>
<li><a class="reference internal" href="#websocket-vs-sockjs">WebSocket vs. SockJs</a></li>
<li><a class="reference internal" href="#configurazione">Configurazione</a></li>
<li><a class="reference internal" href="#componenti">Componenti</a></li>
<li><a class="reference internal" href="#la-funzione-del-servizio">La funzione del servizio</a></li>
<li><a class="reference internal" href="#il-controller">Il controller</a><ul>
<li><a class="reference internal" href="#pagina-indexnaive-html">Pagina indexNaive.html</a></li>
<li><a class="reference internal" href="#pagina-indexbetter-html">Pagina indexBetter.html</a></li>
</ul>
</li>
<li><a class="reference internal" href="#client-in-java-per-programmi">Client (in Java per programmi)</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/SpringBootWebSocketSTOMP.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">iss23 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SpringBootWebSocketSTOMP</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Antonio Natali.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>