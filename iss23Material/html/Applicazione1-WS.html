
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>Applicazione1-WS &#8212; iss23 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <script src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">iss23 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Applicazione1-WS</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="applicazione1-ws">
<h1>Applicazione1-WS<a class="headerlink" href="#applicazione1-ws" title="Permalink to this headline">¶</a></h1>
<p>In questa sezione vogliamo realizzare le interazioni tra
<a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#unibo-appl1-interaction-application1coreconn"><span class="std std-ref">Application1CoreConn</span></a>
e <a class="reference internal" href="VirtualRobot23.html#virtualrobot23"><span class="std std-ref">VirtualRobot23</span></a> utilizzando le <code class="docutils literal notranslate"><span class="pre">WebSocket</span></code>.</p>
<a class="reference internal image-reference" href="_images/Appl1WS.png"><img alt="_images/Appl1WS.png" src="_images/Appl1WS.png" style="width: 35%;" /></a>
<section id="applicazione1-ws-analisi-del-problema">
<h2>Applicazione1-WS: analisi del problema<a class="headerlink" href="#applicazione1-ws-analisi-del-problema" title="Permalink to this headline">¶</a></h2>
<p>Impostare un modo di <a class="reference internal" href="VirtualRobot23.html#interazione-asincrona"><span class="std std-ref">Interazione asincrona</span></a> con il <a class="reference internal" href="VirtualRobot23.html#virtualrobot23"><span class="std std-ref">VirtualRobot23</span></a> significa inviare comandi
in modo <span class="blue">fire-and-forget</span> e ottenere informazioni sul loro esito attraverso un <a class="reference internal" href="VirtualRobot23.html#messaggio-di-stato"><span class="std std-ref">Messaggio di stato</span></a>
che <code class="docutils literal notranslate"><span class="pre">WEnv</span></code> invia a tutti i client connessi.</p>
<p>Il progetto <a class="reference internal" href="unibo.basicomm23.html#unibo-basicomm23"><span class="std std-ref">unibo.basicomm23</span></a> definisce la classe <a class="reference internal" href="Interaction2021-HTTP-WS.html#wsconnection"><span class="std std-ref">WsConnection</span></a>,
che offre all’application designer strumenti e meccanismi utili a gestire questa nuova situazione.</p>
</section>
<section id="supporto-per-robot-via-ws">
<h2>Supporto per robot via WS<a class="headerlink" href="#supporto-per-robot-via-ws" title="Permalink to this headline">¶</a></h2>
<p>Per rendere la struttura dell’applicazione simile a quella di
<a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#unibo-appl1-interaction-application1coreconn"><span class="std std-ref">unibo.appl1.interaction.Application1CoreConn</span></a>, introduciamo
la classe  <a class="reference internal" href="#unibo-supports-vrobothlmovesws"><span class="std std-ref">unibo.supports.VrobotHLMovesWS</span></a>.</p>
<section id="unibo-supports-vrobothlmovesws">
<h3>unibo.supports.VrobotHLMovesWS<a class="headerlink" href="#unibo-supports-vrobothlmovesws" title="Permalink to this headline">¶</a></h3>
<p>Questa classe  realizza le mosse di alto livello
del robot introdotte in <a class="reference internal" href="Applicazione1-HTTP-Core.html#unibo-common-ivrobotmoves"><span class="std std-ref">unibo.common.IVrobotMoves</span></a>, avvalendosi delle comunicazioni di basso livello
sulla <code class="docutils literal notranslate"><span class="pre">WS</span></code>, realizzate da <a class="reference internal" href="Interaction2021-HTTP-WS.html#wsconnection"><span class="std std-ref">WsConnection</span></a>.</p>
<p>Le mosse hanno tutte una durata limitata, ma le interazioni sono di tipo asincrono e per sapere quando una mossa
è terminata occorre gestire il <a class="reference internal" href="VirtualRobot23.html#messaggio-di-stato"><span class="std std-ref">Messaggio di stato</span></a> inviato sulla <code class="docutils literal notranslate"><span class="pre">WS</span></code> da WEnv.</p>
<p>A tal fine <em>VrobotHLMovesWS</em> estende <a class="reference internal" href="unibo.basicomm23.html#applabstractobserver"><span class="std std-ref">ApplAbstractObserver</span></a> e si registra come osservatore sulla <a class="reference internal" href="Interaction2021-HTTP-WS.html#wsconnection"><span class="std std-ref">WsConnection</span></a>.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VrobotHLMovesWS</span> <span class="kd">extends</span> <span class="n">ApplAbstractObserver</span> <span class="kd">implements</span>  <span class="n">IVrobotMoves</span><span class="p">{</span>
  <span class="kd">private</span> <span class="n">Interaction2021</span> <span class="n">wsCommSupport</span><span class="p">;</span>
  <span class="kd">protected</span> <span class="kt">int</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//modified by update</span>

  <span class="kd">public</span> <span class="nf">VrobotHLMovesWS</span><span class="p">(</span> <span class="n">String</span> <span class="n">hostIp</span> <span class="p">)</span> <span class="p">{</span>
      <span class="n">wsCommSupport</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VrobotWsComms</span><span class="p">(</span><span class="n">hostIp</span><span class="p">,</span> <span class="mi">8091</span><span class="p">,</span> <span class="n">obs</span> <span class="p">);</span>
      <span class="n">wsCommSupport</span><span class="p">.</span><span class="na">addObserver</span><span class="p">(</span>  <span class="k">this</span>  <span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>La mossa <span class="blue">halt</span> viene realizzata in modo asincrono, senza attendere alcun messaggio di terminazione
(che non viene inviato) ma solo un tempo adeguato al completamento della mossa.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">halt</span><span class="p">(</span> <span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
   <span class="n">wsCommSupport</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">haltcmd</span><span class="p">);</span>
   <span class="n">CommUtils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span> <span class="c1">//wait for completion</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Le altre mosse ad alto livello del robot sono realizzate ancora in modo <strong>sincrono</strong>, usando
una operazione locale <a class="reference internal" href="#vrobothlmovesws-request"><span class="std std-ref">request</span></a> bloccante.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnLeft</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
  <span class="n">request</span><span class="p">(</span><span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">turnleftcmd</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">turnRight</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
  <span class="n">request</span><span class="p">(</span>  <span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">turnrightcmd</span>  <span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forward</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
   <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">forwardcmd</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">time</span><span class="p">));</span>
   <span class="k">if</span><span class="p">(</span> <span class="n">result</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;collision&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;forward failed&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">backward</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">backwardcmd</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">time</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">result</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;collision&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;backward failed&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">step</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">cmd</span> <span class="o">=</span>  <span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">forwardcmd</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">time</span><span class="p">);</span>
    <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="vrobothlmovesws-request">
<h4>VrobotHLMovesWS.request<a class="headerlink" href="#vrobothlmovesws-request" title="Permalink to this headline">¶</a></h4>
<p>L’operazione <em>request</em> bloccante opera  in due fasi:</p>
<ol class="arabic simple">
<li><p>la prima fase invia il messaggio di richiesta su <code class="docutils literal notranslate"><span class="pre">WS</span></code>, invocando l’operazione <code class="docutils literal notranslate"><span class="pre">forward(String)</span></code> di
<a class="reference internal" href="Interaction2021-HTTP-WS.html#wsconnection-implementa-interaction2021"><span class="std std-ref">WsConnection</span></a>;</p></li>
<li><p>la seconda fase consiste nell’attesa di modifica della variabile locale <code class="docutils literal notranslate"><span class="pre">moveResult</span></code> dalla parte
che realizza <a class="reference internal" href="#vrobothlmovesws-come-observer"><span class="std std-ref">VrobotHLMovesWS come observer</span></a>.</p></li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="n">String</span> <span class="n">moveResult</span>   <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">public</span> <span class="n">String</span> <span class="nf">request</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">moveResult</span>   <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">startTimer</span><span class="p">();</span>
    <span class="n">wsCommSupport</span><span class="p">.</span><span class="na">forward</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>  <span class="c1">//FASE1</span>
    <span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span>  <span class="n">moveResult</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span> <span class="n">wait</span><span class="p">();</span> <span class="p">}</span> <span class="c1">//FASE2</span>
        <span class="k">return</span> <span class="n">moveResult</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dunque <em>request</em> blocca il chiamante fino a che WEnv invia un <a class="reference internal" href="VirtualRobot23.html#messaggio-di-stato"><span class="std std-ref">Messaggio di stato</span></a>
(gestito da <a class="reference internal" href="#vrobothlmovesws-update"><span class="std std-ref">VrobotHLMovesWS.update</span></a>)
che segnala successo o fallimento (collisione).</p>
<p>In questo modo una mossa di durata <code class="docutils literal notranslate"><span class="pre">T</span></code> che termina con successo ha un tempo di esecuzione <code class="docutils literal notranslate"><span class="pre">T</span></code>. Nel caso di
fallimento, le mosse <code class="docutils literal notranslate"><span class="pre">forward</span></code> e <code class="docutils literal notranslate"><span class="pre">backward</span></code> generano una eccezione appena la collisione viene
perceipta, mentre <code class="docutils literal notranslate"><span class="pre">step</span></code> restituisce il valore <em>false</em> dopo il tempo  <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p>
<p>Più avanti (sezione <a class="reference internal" href="#step-asincrono-con-callback"><span class="std std-ref">Step asincrono con callback</span></a>) vedremo come la interazione asincorna potrà indurre
a impostare il funnzionamento di <em>step</em> in modo diverso.</p>
</section>
</section>
<section id="vrobothlmovesws-come-observer">
<h3>VrobotHLMovesWS come observer<a class="headerlink" href="#vrobothlmovesws-come-observer" title="Permalink to this headline">¶</a></h3>
<p>La parte che opera come osservatore è realizzata dal metodo <code class="docutils literal notranslate"><span class="pre">update(String)</span></code>, che viene invocato dal supporto
<a class="reference internal" href="Interaction2021-HTTP-WS.html#unibo-basicomm23-ws-wsconnection"><span class="std std-ref">WsConnection</span></a> (in quanto <a class="reference internal" href="unibo.basicomm23.html#unibo-basicomm23-interfaces-iobservable"><span class="std std-ref">IObservable</span></a>)
quando WEnv trasmette su <code class="docutils literal notranslate"><span class="pre">WS</span></code> l’esito del comando (o un   <a class="reference internal" href="VirtualRobot23.html#messaggio-di-stato"><span class="std std-ref">Messaggio di stato</span></a>).</p>
<p>Questa parte di codice gestisce i messaggi di <span class="blue">fine movimento</span> del robot, aggiornando la variabile <code class="docutils literal notranslate"><span class="pre">moveResult</span></code>
che sblocca la   <a class="reference internal" href="#vrobothlmovesws-request"><span class="std std-ref">VrobotHLMovesWS.request</span></a> in attesa.</p>
<table class="colwidths-given docutils align-default" style="width: 100%">
<colgroup>
<col style="width: 60%" />
<col style="width: 40%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><img alt="_images/forwardOk.png" src="_images/forwardOk.png" />
</td>
<td><p>mossa che termina con successo</p></td>
</tr>
<tr class="row-even"><td><img alt="_images/forwardCollision.png" src="_images/forwardCollision.png" />
</td>
<td><p>mossa che fallisce, provocando una collisione. Il messaggio <span class="blue">collision</span> viene ricevuto da <em>update</em>, ma non
viene gestito a livello applicativo.</p></td>
</tr>
</tbody>
</table>
<section id="vrobothlmovesws-update">
<h4>VrobotHLMovesWS.update<a class="headerlink" href="#vrobothlmovesws-update" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">String</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">try</span> <span class="p">{</span>
         <span class="n">elapsed</span> <span class="o">=</span> <span class="n">getDuration</span><span class="p">();</span>
         <span class="n">JSONObject</span> <span class="n">jsonObj</span> <span class="o">=</span> <span class="n">CommUtils</span><span class="p">.</span><span class="na">parseForJson</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">jsonObj</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">){</span>
             <span class="n">CommUtils</span><span class="p">.</span><span class="na">outred</span><span class="p">(</span><span class="s">&quot;VrobotHLMovesWS | update ERROR Json:&quot;</span> <span class="o">+</span> <span class="n">info</span><span class="p">);</span>
             <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span><span class="p">(</span> <span class="n">info</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;_notallowed&quot;</span><span class="p">)</span> <span class="p">){</span>
             <span class="n">CommUtils</span><span class="p">.</span><span class="na">outred</span><span class="p">(</span><span class="s">&quot;VrobotHLMovesWS |</span>
<span class="s">                     update WARNING!!! _notallowed unexpected in &quot;</span> <span class="o">+</span> <span class="n">info</span><span class="p">);</span>
             <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">jsonObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;collision&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">//Non faccio nulla: attendo moveForward-collision</span>
             <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">jsonObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;endmove&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">//{&quot;endmove&quot;:&quot;true/false &quot;,&quot;move&quot;:&quot;...&quot;}</span>
             <span class="kt">boolean</span> <span class="n">endmove</span> <span class="o">=</span> <span class="n">jsonObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;endmove&quot;</span><span class="p">).</span><span class="na">toString</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">);</span>
             <span class="n">String</span>  <span class="n">move</span>    <span class="o">=</span> <span class="n">jsonObj</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;move&quot;</span><span class="p">).</span><span class="na">toString</span><span class="p">();</span>
             <span class="kd">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
                 <span class="n">moveResult</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">endmove</span><span class="p">;</span>
                 <span class="n">notifyAll</span><span class="p">();</span>
             <span class="p">}</span>
             <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span>  <span class="p">}</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Vediamo ora come impostare una soluzione dell’<a class="reference internal" href="Applicazione1.html#applicazione1"><span class="std std-ref">Applicazione1</span></a> su queste premesse, tenendo anche conto
cha abbiamo già definito una classe astratta <a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#unibo-appl1-common-application1abstractbase"><span class="std std-ref">unibo.appl1.common.Application1AbstractBase</span></a>
che implementa <a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#iapplication1"><span class="std std-ref">IApplication1</span></a>.</p>
</section>
</section>
</section>
<section id="unibo-ws-application1ws">
<h2>unibo.ws.Application1Ws<a class="headerlink" href="#unibo-ws-application1ws" title="Permalink to this headline">¶</a></h2>
<p>Dichiariamo le variabili locali che useremo nell’applicazione.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application1Ws</span> <span class="kd">extends</span> <span class="n">Application1AbstractBase</span><span class="p">{</span>
 <span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">fast</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
 <span class="kd">protected</span> <span class="kt">int</span> <span class="n">stepTIme</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="kd">protected</span> <span class="kt">int</span> <span class="n">NEdges</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="kd">protected</span> <span class="kt">int</span> <span class="n">NSteps</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="kd">protected</span> <span class="n">IVrobotMoves</span> <span class="n">vr</span> <span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vr</span></code>: deve referenziare un oggetto di supporto <a class="reference internal" href="#unibo-supports-vrobothlmovesws"><span class="std std-ref">VrobotHLMovesWS</span></a>  per eseguire le operazioni di alto livello del robot.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NEdges</span></code>: numero di lati percorsi.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NSteps</span></code>: numero di passi effettuati.</p></li>
</ul>
<section id="unibo-ws-application1ws-il-costruttore">
<h3>unibo.ws.Application1Ws: il costruttore<a class="headerlink" href="#unibo-ws-application1ws-il-costruttore" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>public Application1Ws( String hostIp  ){
    this(  hostIp,  new Vector&lt;IObserver&gt;()  );
}

public Application1Ws( String hostIp, Vector&lt;IObserver&gt; externalObs  ){
    super(&quot;Application1Ws&quot;, hostIp, fastPc, externalObs);
    vr = VrobotHLSupportFactory.supportForWS(hostIp);
    stepTIme =  fastPc ? 300 : 500;
}
</pre></div>
</div>
<p>Il codice applicativo che realizza la business-logic con interazione su
<code class="docutils literal notranslate"><span class="pre">WebSocket</span></code> è simile al caso basato su <code class="docutils literal notranslate"><span class="pre">HTTP</span></code> <a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#unibo-appl1-interaction-application1coreconn"><span class="std std-ref">Application1CoreConn</span></a>,
a sua volta simile a <a class="reference internal" href="Applicazione1-HTTP-Core.html#codice-di-unibo-appl1-http-application1httpcore"><span class="std std-ref">Application1Core</span></a>.</p>
</section>
<section id="unibo-ws-application1ws-walkatboundary">
<h3>unibo.ws.Application1Ws: walkAtBoundary<a class="headerlink" href="#unibo-ws-application1ws-walkatboundary" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">walkAtBoundary</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">CommUtils</span><span class="p">.</span><span class="na">waitTheUser</span><span class="p">(</span><span class="s">&quot;PUT ROBOT at HOME and hit to start&quot;</span><span class="p">);</span>
    <span class="n">started</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-athomebegin&quot;</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">4</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">walkAheadUntilCollision</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">vr</span><span class="p">.</span><span class="na">turnLeft</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">started</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-athomeend&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="unibo-ws-application1ws-walkaheaduntilcollision">
<h4>unibo.ws.Application1Ws: walkAheadUntilCollision<a class="headerlink" href="#unibo-ws-application1ws-walkaheaduntilcollision" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">walkAheadUntilCollision</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="kt">boolean</span> <span class="n">stepOk</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">stepOk</span>  <span class="p">)</span> <span class="p">{</span>
        <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-moving&quot;</span><span class="p">);</span>
        <span class="n">NEdges</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">stepOk</span> <span class="o">=</span>  <span class="n">vr</span><span class="p">.</span><span class="na">step</span><span class="p">(</span><span class="n">stepTime</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">stepOk</span> <span class="p">)</span> <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-collision&quot;</span><span class="p">);</span>
        <span class="k">else</span> <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-stable&quot;</span><span class="p">);</span>
        <span class="n">CommUtils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span> <span class="c1">//to view the steps better</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">stopped</span> <span class="p">)</span> <span class="p">{</span>
            <span class="n">updateObservers</span><span class="p">(</span><span class="s">&quot;robot-stopped&quot;</span><span class="p">);</span>
            <span class="n">waitResume</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="unibo-ws-application1ws-main">
<h4>unibo.ws.Application1Ws: main<a class="headerlink" href="#unibo-ws-application1ws-main" title="Permalink to this headline">¶</a></h4>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">Application1Ws</span> <span class="n">appl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Application1Ws</span><span class="p">(</span> <span class="s">&quot;localhost&quot;</span>  <span class="p">);</span>
    <span class="n">appl</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="observerfortestingappl1">
<h3>ObserverForTestingAppl1<a class="headerlink" href="#observerfortestingappl1" title="Permalink to this headline">¶</a></h3>
<p>Definiamo un observer utile in fase di testing automatizzato dell’applicazione.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ObserverForTestingAppl1</span> <span class="kd">extends</span> <span class="n">ApplAbstractObserver</span> <span class="p">{</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="n">applIsTerminated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">private</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">history</span>    <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">history</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">message</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&quot;robot-athomeend&quot;</span><span class="p">))</span> <span class="n">setTerminated</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//permette di riusare un observer in fase di testing</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
        <span class="n">history</span>          <span class="o">=</span> <span class="k">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">applIsTerminated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getHistory</span><span class="p">(){</span>
        <span class="k">return</span> <span class="n">history</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setTerminated</span><span class="p">(){</span>
        <span class="n">CommUtils</span><span class="p">.</span><span class="na">outblue</span><span class="p">(</span><span class="s">&quot;         ObserverForTesting | appl terminated &quot;</span>  <span class="p">);</span>
        <span class="n">applIsTerminated</span> <span class="o">=</span><span class="kc">true</span><span class="p">;</span>
        <span class="n">notifyAll</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">waitApplTerminated</span><span class="p">(){</span>
        <span class="k">while</span><span class="p">(</span> <span class="o">!</span> <span class="n">applIsTerminated</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">wait</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{...}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="step-asincrono-con-callback">
<h2>Step asincrono con callback<a class="headerlink" href="#step-asincrono-con-callback" title="Permalink to this headline">¶</a></h2>
<p>L’idea di <em>step asincrono con callback</em>  consiste nel pensare che siano definite le azioni
da svolgere nel caso di step che termina con sucesso  (<code class="docutils literal notranslate"><span class="pre">stepok</span></code>)
e di step che fallisce per via di una collisione (<code class="docutils literal notranslate"><span class="pre">stepfail</span></code>).</p>
<p>Il compito ell’operazione:</p>
<p><code class="docutils literal notranslate"><span class="pre">public</span> <span class="pre">void</span> <span class="pre">stepAsynch(int</span> <span class="pre">time,</span> <span class="pre">IWsInfoHandler</span> <span class="pre">stepok,</span> <span class="pre">IWsInfoHandler</span> <span class="pre">stepfail</span> <span class="pre">)</span></code></p>
<p>è di eseguire uno <em>step</em> e invocare <code class="docutils literal notranslate"><span class="pre">stepok</span></code> oppure <code class="docutils literal notranslate"><span class="pre">stepfail</span></code> a seconda dell’esito del comando.</p>
<p><span class="remark">Questo modo di interazione può condurre all’inferno delle callback</span></p>
<p>Introduciamo dunque un’interfaccia che stabilisce l’azione da compiere per la gestione di un <a class="reference internal" href="VirtualRobot23.html#messaggio-di-stato"><span class="std std-ref">Messaggio di stato</span></a>.</p>
<section id="unibo-appl1-common-iwsinfohandler">
<h3>unibo.appl1.common.IWsInfoHandler<a class="headerlink" href="#unibo-appl1-common-iwsinfohandler" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IWsInfoHandler</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">)</span>  <span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="vrobothlmovesws-stepasynch">
<h3>VrobotHLMovesWS.stepAsynch<a class="headerlink" href="#vrobothlmovesws-stepasynch" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>L’operazione <em>stepAsynch</em> invoca, usando <a class="reference internal" href="#vrobothlmovesws-request"><span class="std std-ref">request</span></a>, l’operazione asincrona
<code class="docutils literal notranslate"><span class="pre">forward</span></code> su <a class="reference internal" href="Interaction2021-HTTP-WS.html#wsconnection"><span class="std std-ref">WsConnection</span></a>. Se <em>request</em> restitusce <code class="docutils literal notranslate"><span class="pre">true</span></code>, <em>stepAsynch</em> invoca   la callback <code class="docutils literal notranslate"><span class="pre">stepok</span></code>,
altrimenti invoca  <code class="docutils literal notranslate"><span class="pre">stepfail</span></code></p></li>
<li><p>La inovazione mediante <a class="reference internal" href="#vrobothlmovesws-request"><span class="std std-ref">request</span></a> viene eseguita all’interno di un nuovo Thread <code class="docutils literal notranslate"><span class="pre">ThS</span></code>
per evitare il blocco del chiamante.</p></li>
<li><p>Per meglio comprendere il funzionamento, <em>stepAsynch</em> tiene traccai dei teni di esecuzione.</p></li>
</ul>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stepAsynch</span><span class="p">(</span><span class="kt">int</span> <span class="n">time</span><span class="p">,</span> <span class="n">IWsInfoHandler</span> <span class="n">stepok</span><span class="p">,</span> <span class="n">IWsInfoHandler</span> <span class="n">stepko</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="n">Thread</span><span class="p">(){</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">(){</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">startTimer</span><span class="p">();</span>
                <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
                <span class="n">String</span> <span class="n">result</span>  <span class="o">=</span> <span class="n">request</span><span class="p">(</span><span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">forwardcmd</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">time</span><span class="p">));</span>
                <span class="kt">long</span> <span class="n">elapsed</span>   <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">))</span> <span class="n">stepok</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span><span class="s">&quot;w ok duration:&quot;</span> <span class="o">+</span> <span class="n">elapsed</span><span class="p">);</span>
                <span class="k">else</span> <span class="n">stepko</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="s">&quot; duration:&quot;</span> <span class="o">+</span> <span class="n">elapsed</span><span class="p">);</span>
            <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span> <span class="n">stepko</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span><span class="s">&quot;step error:&quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="soluzione-con-stepasynch">
<h2>Soluzione con stepAsynch<a class="headerlink" href="#soluzione-con-stepasynch" title="Permalink to this headline">¶</a></h2>
<p>Iniziamo impostando le azioni da svolgere nel caso di step che termina con sucesso
e di step che fallisce per via di una collisione.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="n">IWsInfoHandler</span> <span class="n">stepok</span>   <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">CommUtils</span><span class="p">.</span><span class="na">outblue</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="n">NSteps</span><span class="o">++</span><span class="p">;</span>
    <span class="n">CommUtils</span><span class="p">.</span><span class="na">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span> <span class="c1">//to view steps better</span>
    <span class="n">doWalkingstep</span><span class="p">();</span>
<span class="p">});</span>

<span class="n">IWsInfoHandler</span> <span class="n">stepfail</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="n">vr</span><span class="p">.</span><span class="na">halt</span><span class="p">();</span>  <span class="c1">//to avoid turnLeft_notallowed</span>
        <span class="n">NEdges</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">vr</span><span class="p">.</span><span class="na">turnLeft</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NEdges</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">)</span> <span class="n">doWalkingstep</span><span class="p">();</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span> <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();}</span>
<span class="p">});</span>

<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doWalkingstep</span><span class="p">(</span> <span class="p">)</span>  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">stopped</span> <span class="p">)</span> <span class="n">waitResume</span><span class="p">();</span>
    <span class="p">((</span><span class="n">VrobotHLMovesWS</span><span class="p">)</span><span class="n">vr</span><span class="p">).</span><span class="na">stepAsynch</span><span class="p">(</span> <span class="n">stepTIme</span><span class="p">,</span> <span class="n">stepok</span><span class="p">,</span> <span class="n">stepfail</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A questo punto inneschiamo il procedimento invocando l’operazione <code class="docutils literal notranslate"><span class="pre">doWalkingstep</span></code> che effettua il primo step.</p>
<div class="highlight-Java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doJob</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="p">{</span>
    <span class="n">doWalkingstep</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="uso-di-annotazioni">
<h2>Uso di annotazioni<a class="headerlink" href="#uso-di-annotazioni" title="Permalink to this headline">¶</a></h2>
<section id="definizione-delle-annotazioni">
<h3>Definizione delle annotazioni<a class="headerlink" href="#definizione-delle-annotazioni" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Target</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">StepOk</span> <span class="p">{</span> <span class="p">}</span>

<span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
<span class="nd">@Target</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">METHOD</span><span class="p">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">StepFail</span> <span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="in-application1abstractbase">
<h3>In Application1AbstractBase<a class="headerlink" href="#in-application1abstractbase" title="Permalink to this headline">¶</a></h3>
<p>In <a class="reference internal" href="Applicazione1-HTTP-Distribuita.html#unibo-appl1-common-application1abstractbase"><span class="std std-ref">Application1AbstractBase</span></a> introduciamo una utility <code class="docutils literal notranslate"><span class="pre">scanMethodAnnotation</span></code>
(da invocare nel costruttore) per individuare e memorizzare i metodi annotati entro la classe (specializzata).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">protected</span> <span class="n">Method</span> <span class="n">stepOk</span><span class="p">;</span>
<span class="n">protected</span> <span class="n">Method</span> <span class="n">stepFail</span><span class="p">;</span>

<span class="n">public</span> <span class="n">Application1AbstractBase</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">String</span> <span class="n">hostIp</span><span class="p">,</span>
                    <span class="n">boolean</span> <span class="n">fastPc</span><span class="p">,</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">IObserver</span><span class="o">&gt;</span> <span class="n">externalObs</span><span class="p">){</span>
    <span class="o">...</span>
    <span class="n">scanMethodAnnotation</span><span class="p">(</span>   <span class="p">);</span>
<span class="p">}</span>

<span class="n">public</span> <span class="n">void</span> <span class="n">scanMethodAnnotation</span><span class="p">(</span>   <span class="p">)</span> <span class="p">{</span>
    <span class="n">Method</span><span class="p">[]</span> <span class="n">m</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getDeclaredMethods</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isAnnotationPresent</span><span class="p">(</span><span class="n">StepOk</span><span class="o">.</span><span class="n">class</span><span class="p">))</span> <span class="p">{</span>  <span class="n">stepOk</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isAnnotationPresent</span><span class="p">(</span><span class="n">StepFail</span><span class="o">.</span><span class="n">class</span><span class="p">))</span> <span class="p">{</span> <span class="n">stepFail</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="application1wsannot">
<h3>Application1WsAnnot<a class="headerlink" href="#application1wsannot" title="Permalink to this headline">¶</a></h3>
<p>Nella nuova versione dell’applicazione (<code class="docutils literal notranslate"><span class="pre">unibo.appl1.ws.Application1WsAnnot</span></code>) definiamo i metodi annotati
che corrispondono alla esecuzione  di uno step con successo e con fallimento.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application1WsAnnot</span> <span class="kd">extends</span> <span class="n">Application1AbstractBase</span> <span class="p">{</span>
<span class="p">...</span>

<span class="nd">@StepOk</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">stepOk</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">){</span>
     <span class="n">NSteps</span><span class="o">++</span><span class="p">;</span>
     <span class="n">doWalkingstep</span><span class="p">();</span>
<span class="p">}</span>

<span class="nd">@StepFail</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">stepfail</span><span class="p">(</span><span class="n">String</span> <span class="n">msg</span><span class="p">){</span>
   <span class="k">try</span><span class="p">{</span>
        <span class="n">vr</span><span class="p">.</span><span class="na">halt</span><span class="p">();</span>  <span class="c1">//to avoid turnLeft_notallowed</span>
        <span class="n">NEdges</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">vr</span><span class="p">.</span><span class="na">turnLeft</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">NEdges</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">)</span> <span class="n">doWalkingstep</span><span class="p">();</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span> <span class="p">...</span> <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Nella applicazione definiamo anche un metodo che effettua uno <em>step</em> invocando <a class="reference internal" href="#vrobothlmovesws-request"><span class="std std-ref">request</span></a>
e l’oppoprtuno metodo annotato a seconda del risultato.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doWalkingstep</span><span class="p">(</span> <span class="p">)</span>  <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">stopped</span> <span class="p">)</span> <span class="n">waitResume</span><span class="p">();</span>
    <span class="n">dostepAsynchWithAnnot</span><span class="p">(</span> <span class="n">stepTIme</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">dostepAsynchWithAnnot</span><span class="p">(</span> <span class="kt">int</span> <span class="n">time</span>  <span class="p">)</span> <span class="p">{</span>
 <span class="k">try</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
    <span class="n">String</span> <span class="n">result</span>  <span class="o">=</span> <span class="p">((</span><span class="n">VrobotHLMovesWS</span><span class="p">)</span><span class="n">vr</span><span class="p">).</span><span class="na">request</span><span class="p">(</span>
                <span class="n">VrobotMsgs</span><span class="p">.</span><span class="na">forwardcmd</span><span class="p">.</span><span class="na">replace</span><span class="p">(</span><span class="s">&quot;TIME&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">time</span><span class="p">));</span>
    <span class="kt">long</span> <span class="n">elapsed</span>   <span class="o">=</span> <span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;true&quot;</span><span class="p">))</span>  <span class="n">stepOk</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&quot;w ok duration:&quot;</span> <span class="o">+</span> <span class="n">elapsed</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">stepFail</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&quot; duration:&quot;</span> <span class="o">+</span> <span class="n">elapsed</span><span class="p">);</span>
 <span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">){</span> <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Applicazione1-WS</a><ul>
<li><a class="reference internal" href="#applicazione1-ws-analisi-del-problema">Applicazione1-WS: analisi del problema</a></li>
<li><a class="reference internal" href="#supporto-per-robot-via-ws">Supporto per robot via WS</a><ul>
<li><a class="reference internal" href="#unibo-supports-vrobothlmovesws">unibo.supports.VrobotHLMovesWS</a><ul>
<li><a class="reference internal" href="#vrobothlmovesws-request">VrobotHLMovesWS.request</a></li>
</ul>
</li>
<li><a class="reference internal" href="#vrobothlmovesws-come-observer">VrobotHLMovesWS come observer</a><ul>
<li><a class="reference internal" href="#vrobothlmovesws-update">VrobotHLMovesWS.update</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#unibo-ws-application1ws">unibo.ws.Application1Ws</a><ul>
<li><a class="reference internal" href="#unibo-ws-application1ws-il-costruttore">unibo.ws.Application1Ws: il costruttore</a></li>
<li><a class="reference internal" href="#unibo-ws-application1ws-walkatboundary">unibo.ws.Application1Ws: walkAtBoundary</a><ul>
<li><a class="reference internal" href="#unibo-ws-application1ws-walkaheaduntilcollision">unibo.ws.Application1Ws: walkAheadUntilCollision</a></li>
<li><a class="reference internal" href="#unibo-ws-application1ws-main">unibo.ws.Application1Ws: main</a></li>
</ul>
</li>
<li><a class="reference internal" href="#observerfortestingappl1">ObserverForTestingAppl1</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-asincrono-con-callback">Step asincrono con callback</a><ul>
<li><a class="reference internal" href="#unibo-appl1-common-iwsinfohandler">unibo.appl1.common.IWsInfoHandler</a></li>
<li><a class="reference internal" href="#vrobothlmovesws-stepasynch">VrobotHLMovesWS.stepAsynch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#soluzione-con-stepasynch">Soluzione con stepAsynch</a></li>
<li><a class="reference internal" href="#uso-di-annotazioni">Uso di annotazioni</a><ul>
<li><a class="reference internal" href="#definizione-delle-annotazioni">Definizione delle annotazioni</a></li>
<li><a class="reference internal" href="#in-application1abstractbase">In Application1AbstractBase</a></li>
<li><a class="reference internal" href="#application1wsannot">Application1WsAnnot</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Applicazione1-WS.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">iss23 1.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Applicazione1-WS</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Antonio Natali.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>